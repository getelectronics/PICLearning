
;experiment purpose: familiar the method of remote control receive code and decode

;LED display decode result:high four bits are user code ,low two bits are key code.

;hardware request:SW S10 the second bit ON ,the other bit OFF,SW S5,S6 all ON,the others SW OFF
 #include<p16f877a.inc>
__CONFIG _DEBUG_OFF&_CP_ALL&_WRT_HALF&_CPD_ON&_LVP_OFF&_BODEN_OFF&_PWRTE_ON&_WDT_OFF&_HS_OSC
;-------------------------
RMT            EQU 1                  ;remote control INPUT I/O(RA.1)                                                                                                                                                     
BITIN          EQU 7                  ;remote control receive data flag                                                                                                                                                   
;-------------------------                                                                                                                                                                                                
CNT0           EQU 20H                ;user temporary register 1                                                                                                                                                          
CNT1           EQU 21H                ;user temporary register 2                                                                                                                                                          
CNT2           EQU 22H                ;user temporary register 3                                                                                                                                                          
CNT3           EQU 23H                ;user temporary register 4                                                                                                                                                          
FLAGS2         EQU 24H                ;temporary register                                                                                                                                                                 
                                                                                                                                                                                                                          
CSR0A          EQU 25H                 ;control receive 32 bits data temporary register                                                                                                                                   
CSR1A          EQU 26H                 ;control receive 32 bits data temporary register                                                                                                                                   
CSR2A          EQU 27H                 ;control receive 32 bits data temporary register                                                                                                                                   
CSR3A          EQU 28H                 ;control receive 32 bits data temporary register                                                                                                                                   
;--------------------                                                                                                                                                                                                     
               ORG 0000H               ;reset address                                                                                                                                                                     
               NOP                     ;the nop instruction of ICD require                                                                                                                                                
               GOTO MAIN               ;jump to main program                                                                                                                                                              
               ORG  0004H              ;interrupt program entrance address                                                                                                                                                
               RETFIE                 ;place a interrupt return instruction,prevent suddenness entry interrupt                                                                                                             ;放置一条中断返回指令，防止意外进入中断
               ORG  0008H
;------------------------------------------------
TABLE                               
               ADDWF       PCL,1          ;instruction register add excursion address                 	                                                                                                                                                                                                                                                                                                                                                                                                                                                                    	
	           RETLW       0C0H       ;the code of 0( the common LED is anode)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
               RETLW       0F9H           ;the code of 1                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
               RETLW       0A4H           ;the code of 2                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
               RETLW       0B0H           ;the code of 3                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
               RETLW       99H            ;the code of 4                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
               RETLW       92H            ;the code of 5                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
	           RETLW       082H 	     ;6                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      ;6
	           RETLW       0F8H 	     ;7
	           RETLW       080H 	     ;8
	           RETLW       090H 	     ;9
               RETLW       88H           ;A
               RETLW       083H          ;b
               RETLW       0C6H          ;c 
               RETLW       0A1H          ;d
               RETLW       086H          ;E
               RETLW       08EH          ;F

MAIN
               CLRF        PORTD         ;initialize I/O PORT                                                                                                                                                                                                                                                                           
               MOVLW       0FFH                                                                                                                                                                                                                                                                                                         
               MOVWF       PORTA                                                                                                                                                                                                                                                                                                        
               BSF         STATUS,RP0    ;set BANK1                                                                                                                                                                                                                                                                                     
               MOVLW       07H                                                                                                                                                                                                                                                                                                          
               MOVWF       ADCON1        ;set RA PORT all general data I/O                                                                                                                                                                                                                                                              
               MOVLW       0C2H          ;set RMT INPUT,the others I/O OUTPUT                                                                                                                                                                                                                                                           
               MOVWF       TRISA                                                                                                                                                                                                                                                                                                        
               CLRF        TRISD                                                                                                                                                                                                                                                                                                        
               BCF         STATUS,RP0    ;reset BANK0                                                                                                                                                                                                                                                                                   
               CLRF        CSR0A                                                                                                                                                                                                                                                                                                        
               CLRF        CSR1A
               CLRF        CSR2A
               CLRF        CSR3A

;--------------------------------------------------
LOOP	       
               BTFSS       PORTA,RMT      ;if remote control press a key                                                                                                                                                                                                                                 
               GOTO        RCV           ;check repeat                                                                                                                                                                                                                                                   
               CALL        DISPLAY                                                                                                                                                                                                                                                                       
               GOTO        LOOP                           
;--------------------------------------------------
RCV
               BTFSC       PORTA,RMT
               GOTO        LOOP           ;exit because disturb                                                                                                                                                                                                                                 
               MOVLW        .4                                                                                                                                                                                                                                                                  
               MOVWF       CNT1           ;4*256*10us                                                                                                                                                                                                                                           
               CLRF        CNT2                                                                                                                                                                                                                                                                 
               CLRF        CNT0                                                                                                                                                                                                                                                                 
RCV1                                      ;first check 9MS low of lead code                                                                                                                                                                                                                     
               GOTO        $+1            ;one circle 10US                                                                                                                                                                                                                                      
               NOP                                                                                                                                                                                                                                                                              
               BTFSC       PORTA,RMT                                                                                                                                                                                                                                                            
               INCF        CNT2,1                                                                                                                                                                                                                                                               
               BTFSS       PORTA,RMT                                                                                                                                                                                                                                                            
               CLRF        CNT2                                                                                                                                                                                                                                                                 
               BTFSC       CNT2,3          ;high electricity longer than 8*10US=80US is efficiency high electricity,otherwise is disturb signal                                                                                                                                                 
               GOTO        RCV2                                                                                                                                                                                                                                                                 
               DECFSZ      CNT0,1                                                                                                                                                                                                                                                               
               GOTO        RCV1                                                                                                                                                                                                                                                                 
               DECFSZ      CNT1,1                                                                                                                                                                                                                                                               
               GOTO        RCV1                                                                                                                                                                                                                                                                 
               GOTO        LOOP            ;low electricity longer than 4*256*10US=10.24MS is wrong signal                                                                                                                                                                                      
RCV2                                                                                                                                                                                                                                                                                            
               MOVLW        .3                                                                                                                                                                                                                                                                  
               SUBWF       CNT1,0          ;low electricity shorter than 2*256*10US=5.12MS is wrong signal                                                                                                                                                                                      
               SKPNC                                                                                                                                                                                                                                                                            
               GOTO        LOOP                                                                                                                                                                                                                                                                 
               MOVLW       .3                                                                                                                                                                                                                                                                   
               MOVWF       CNT1            ;3*256*10us                                                                                                                                                                                                                                          
               CLRF        CNT2                                                                                                                                                                                                                                                                 
               CLRF        CNT0                                                                                                                                                                                                                                                                 
RCV3                                                                                                                                                                                                                                                                                            
               GOTO        $+1             ;10US a circle                                                                                                                                                                                                                                       
               NOP                                                                                                                                                                                                                                                                              
               BTFSS       PORTA,RMT                                                                                                                                                                                                                                                            
               INCF        CNT2,1                                                                                                                                                                                                                                                               
               BTFSC       PORTA,RMT                                                                                                                                                                                                                                                            
               CLRF        CNT2                                                                                                                                                                                                                                                                 
               BTFSC       CNT2,3          ;low electricity longer than 8*10US=80US is efficiency high electricity,otherwise is disturb signal                                                                                                                                                  
               GOTO        RCV4                                                                                                                                                                                                                                                                 
               DECFSZ      CNT0,1                                                                                                                                                                                                                                                               
               GOTO        RCV3                                                                                                                                                                                                                                                                 
               DECFSZ      CNT1,1                                                                                                                                                                                                                                                               
               GOTO        RCV3                                                                                                                                                                                                                                                                 
               GOTO        LOOP            ;high electricity longer than 3*256*10US=7.68MS is wrong signal                                                                                                                                                                                      
RCV4                                                                                                                                                                                                                                                                                            
               MOVLW       .3                                                                                                                                                                                                                                                                   
               SUBWF       CNT1,0          ;high electricity shorter than 1*256*10US=2.56MS is wrong signal                                                                                                                                                                                     
               SKPNC                                                                                                                                                                                                                                                                            
               GOTO        LOOP                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                
               MOVLW       .32                                                                                                                                                                                                                                                                  
               MOVWF      CNT2             ;receive data 32 bits,16 bits are user code ,8 bits are control code add 8 bits control code in reverse.                                                                                                                                             
RCV5                                                                                                                                                                                                                                                                                            
               CLRF       CNT3                                                                                                                                                                                                                                                                  
               MOVLW      .170             ;low electricity longer than 256-170=86*10US=860US is wrong                                                                                                                                                                                          
               MOVWF      CNT0                                                                                                                                                                                                                                                                  
               MOVLW      .56                                                                                                                                                                                                                                                                   
               MOVWF      CNT1             ;high electricity longer than 256-56=200*10US=2MS is wrong                                                                                                                                                                                           
RCV5_HI                                                                                                                                                                                                                                                                                         
               GOTO       $+1                                                                                                                                                                                                                                                                   
               NOP                                                                                                                                                                                                                                                                              
               BTFSC      PORTA,RMT                                                                                                                                                                                                                                                             
               INCF       CNT3,1                                                                                                                                                                                                                                                                
               BTFSS      PORTA,RMT                                                                                                                                                                                                                                                             
               CLRF       CNT3                                                                                                                                                                                                                                                                  
               BTFSC      CNT3,2            ;high electricity longer than 8*10US=80US is true                                                                                                                                                                                                   
               GOTO       RCV6                                                                                                                                                                                                                                                                  
               INCFSZ     CNT0,1                                                                                                                                                                                                                                                                
               GOTO       RCV5_HI           ;low electricity longer than 256-170=86*10US=860US is wrong                                                                                                                                                                                         
               GOTO       LOOP                                                                                                                                                                                                                                                                  
RCV6                                                                                                                                                                                                                                                                                            
               CLRF       CNT3                                                                                                                                                                                                                                                                  
RCV6_LO                                                                                                                                                                                                                                                                                         
               GOTO       $+1                                                                                                                                                                                                                                                                   
               NOP                                                                                                                                                                                                                                                                              
               BTFSS      PORTA,RMT                                                                                                                                                                                                                                                             
               INCF       CNT3,1                                                                                                                                                                                                                                                                
               BTFSC      PORTA,RMT                                                                                                                                                                                                                                                             
               CLRF       CNT3                                                                                                                                                                                                                                                                  
               BTFSC      CNT3,3             ;low electricity longer than 8*10US=80US is true                                                                                                                                                                                                   
               GOTO       COMPARE                                                                                                                                                                                                                                                               
               INCFSZ     CNT1,1                                                                                                                                                                                                                                                                
               GOTO       RCV6_LO            ;high electricity longer than 256-56=200*10US=2MS is wrong                                                                                                                                                                                         
               GOTO       LOOP                                                                                                                                                                                                                                                                  
COMPARE                                                                                                                                                                                                                                                                                         
               MOVLW        .170                                                                                                                                                                                                                                                                
               SUBWF        CNT0,1           ;CNT0 sub original value equal to low electricity counter                                                                                                                                                                                          
               MOVLW        .56                                                                                                                                                                                                                                                                 
               SUBWF        CNT1,1           ;CNT1 sub original value equal to high electricity counter                                                                                                                                                                                         
               MOVFW        CNT1                                                                                                                                                                                                                                                                
               ADDWF        CNT0,1           ;add low electricity counter and high electricity counter ,keep in CNT0 ,compare time t0 make sure 1 or 0                                                                                                                                          
               SKPNC                                                                                                                                                                                                                                                                            
               GOTO         LOOP             ;result bigger than 255 is wrong                                                                                                                                                                                                                   
               MOVLW        .70                                                                                                                                                                                                                                                                 
               SUBWF        CNT0,0                                                                                                                                                                                                                                                              
               SKPC                                                                                                                                                                                                                                                                             
               GOTO         LOOP            ;total time less than 700US is wrong                                                                                                                                                                     
               MOVLW        .130            ;130*10=1.3MS                                                                                                                                                                                            
               SUBWF        CNT0,0                                                                                                                                                                                                                   
               SKPNC                                                                                                                                                                                                                                 
               GOTO         COMPARE_H       ;time longer than 1.3MS is 1                                                                                                                                                                             
               BCF          FLAGS2,BITIN    ;time is in the middle of 700US-1.3MS is 0                                                                                                                                                               
               GOTO         MOVDATA         ;send data                                                                                                                                                                                               
COMPARE_H                                                                                                                                                                                                                                            
               MOVLW        .160                                                                                                                                                                                                                     
               SUBWF        CNT0,0                                                                                                                                                                                                                   
               SKPC                                                                                                                                                                                                                                  
               GOTO         LOOP            ;less than 160*10US=1.6MS,is wrong                                                                                                                                                                       
               MOVLW        .230                                                                                                                                                                                                                     
               SUBWF        CNT0,0                                                                                                                                                                                                                   
               SKPNC                                                                                                                                                                                                                                 
               GOTO         LOOP            ;longer than 230*10US=2.3MS, is wrong                                                                                                                                                                    
               BSF          FLAGS2,BITIN    ;time is in the middle of 1.6MS-2.3MS is 1                                                                                                                                                               
MOVDATA                                                                                                                                                                                                                                              
               RRF         CSR0A,1           ;shift every bit  in correspond register                                                                                                                                                                
               RRF         CSR1A,1                                                                                                                                                                                                                   
               RRF         CSR2A,1                                                                                                                                                                                                                   
               RRF         CSR3A,1                                                                                                                                                                                                                   
               BCF         CSR0A,7                                                                                                                                                                                                                   
               BTFSC       FLAGS2,BITIN     ;receive currently bit to CSR0.7                                                                                                                                                                         
               BSF         CSR0A,7                                                                                                                                                                                                                   
               DECFSZ      CNT2,1           ;if finish receive 32 bits                                                                                                                                                                               
               GOTO        RCV5                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                     
               COMF        CSR0A,0          ;compare if  key  reverse code  is  reversed equal to key code                                                                                                                                           
               XORWF       CSR1A,0                                                                                                                                                                                                                   
               BNZ         LOOP             ;not equal is wrong communication                                                                                                                                                                        
               CALL        DISPLAY          ;call display program                                                                                                                                                                                    
               GOTO        LOOP

;*******************************display program*******************************
;entrance parameter：CSR1A，CSR2A，CSA3A
;exit parameter：no                     
DISPLAY    
               BANKSEL     TRISA
               CLRF        TRISA            ;set A PORT all OUTPUT                                                                                                                
               CLRF        STATUS                                                                                                                                                 
               SWAPF       CSR3A,0          ;display user code the first bit                                                                                                      
               ANDLW       0FH                                                                                                                                                    
               CALL        TABLE                                                                                                                                                  
               MOVWF       PORTD                                                                                                                                                  
               BCF         PORTA,0                                                                                                                                                
               CALL        DELAY                                                                                                                                                  
               BSF         PORTA,0                                                                                                                                                
                                                                                                                                                                                  
               MOVLW       0FH                                                                                                                                                    
               ANDWF       CSR3A,0          ;display user code the second bit                                                                                                     
               CALL        TABLE                                                                                                                                                  
               MOVWF       PORTD                                                                                                                                                  
               BCF         PORTA,1                                                                                                                                                
               CALL        DELAY                                                                                                                                                  
               BSF         PORTA,1                                                                                                                                                
                                                                                                                                                                                  
               SWAPF       CSR2A,0          ;display user code the third bit                                                                                                      
               ANDLW       0FH                                                                                                                                                    
               CALL        TABLE                                                                                                                                                  
               MOVWF       PORTD                                                                                                                                                  
               BCF         PORTA,2                                                                                                                                                
               CALL        DELAY                                                                                                                                                  
               BSF         PORTA,2                                                                                                                                                
                                                                                                                                                                                  
               MOVLW       0FH                                                                                                                                                    
               ANDWF       CSR2A,0          ;display user code the fourth bit                                                                                                     
               CALL        TABLE                                                                                                                                                  
               MOVWF       PORTD
               BCF         PORTA,3
               CALL        DELAY
               BSF         PORTA,3

               SWAPF       CSR1A,0           ;display key code high bit                                                                                                                                          
               ANDLW       0FH                                                                                                                                                                                   
               CALL        TABLE                                                                                                                                                                                 
               MOVWF       PORTD                                                                                                                                                                                 
               BCF         PORTA,4                                                                                                                                                                               
               CALL        DELAY                                                                                                                                                                                 
               BSF         PORTA,4                                                                                                                                                                               
                                                                                                                                                                                                                 
               MOVLW       0FH                                                                                                                                                                                   
               ANDWF       CSR1A,0           ;display key code low bit                                                                                                                                           
               CALL        TABLE                                                                                                                                                                                 
               MOVWF       PORTD                                                                                                                                                                                 
               BCF         PORTA,5                                                                                                                                                                               
               CALL        DELAY                                                                                                                                                                                 
               BSF         PORTA,5                                                                                                                                                                               
                                                                                                                                                                                                                 
               BANKSEL     TRISA                                                                                                                                                                                 
               MOVLW       0C2H              ;reset remote control I/O INPUT                                                                                                                                     
               MOVWF       TRISA                                                                                                                                                                                 
               CLRF        STATUS
               RETURN
       
;***************************delay subprogram************************************    
DELAY
 MOVLW   01H                     
 MOVWF   30H
 MOVLW   0FFH
 MOVWF   31H
 DECFSZ  31H,1
 GOTO    $-1
 DECFSZ  30H,1
 GOTO    $-5
 RETURN

;**********************************************************************
               END                          ;program end      
